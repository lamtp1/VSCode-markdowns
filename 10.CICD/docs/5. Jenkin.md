- Để jenkins tự động chạy mỗi khi có code đẩy lên github thì phải chạy manual trước.

- Nếu tên branch không phải `master` thì phải đề cập tên nhánh trong Jenkinsfile (ngoài việc ghi tên branch trong config của project là bắt buộc) nếu không Jenkins pipeline sẽ lỗi như sau:

![git2](../img/git2.PNG)

Ví dụ về Jenkinsfile không lỗi:

        pipeline {
            agent any
            stages {
                stage('Checkout') {
                    steps {
                        git branch: 'main', 
                            url: 'https://github.com/lamtp1/VSCode-markdowns.git'
                    }
                }
            }
        }

Thảm khảo cách fix lỗi ở: https://community.jenkins.io/t/error-couldnt-find-any-revision-to-build/14430/2


### Cách bật hệ thống jenkins test trên LAPTOP

1. Bật Docker desktop, start container jenkins
2. Bật ngrok, gõ `ngrok http 80` để public IP cho jenkins để github có thể bắn notify cho jenkins biết có thay đổi và tự kéo code về build
3. Sử dụng IP mới tạo để vào jenkins.
4. Vào github --> settings --> webhooks, paste ip của jenkins vào payload url và thêm đuôi /github-webhook/ như sau: https://90fc-220-231-123-41.ngrok-free.app/github-webhook/
5. Trên Jenkins, chọn New Item --> Free Style Project/Pipeline. Đối với Free Style project thì cần thêm những mục sau vào phần config:

![git4](../img/git4.PNG)

![git5](../img/git5.PNG)

Chú ý phần nhánh thì chọn nhánh tùy thích, mặc định nếu không điền thì tên nhánh sẽ là `*/master`.
Khi có thay đổi về source trên github (thêm sửa xóa) thì github sẽ bắn notify qua webhook cho jenkins biết và jenkins sẽ tự kéo code mới về (hiện tại trong bài là kéo code về trong container jenkins luôn), kết quả như hình:

![git6](../img/git6.PNG)

![git7](../img/git7.PNG)

- Trong VD này, máy upcode có thể là máy bàn ở nhà --> up lên github --> máy cài Jenkins + ngrok (laptop trên cty) phát hiện thay đổi code trên github --> kéo code về laptop (code kéo về sẽ ở trong container cài jenkins). Yêu cầu là máy cài Jenkins phải bật 24/7 và có kết nối mạng --> nên thay bằng máy ảo của AWS.

Đối với Item là Pipeline thì cần điền những phần sau trong file config:

![git8](../img/git8.PNG)

![git9](../img/git9.PNG)

![git10](../img/git10.PNG)

![git11](../img/git11.PNG)

Phần Script path để path của file Jenkinsfile trên github
Config xong, chọn `Build Now` để test pipeline trước khi chạy tự động, kết quả pipeline:

![git12](../img/git12.PNG)

* Chỉ cần chạy tự động lần đầu tiên với Jenkins Pipeline, lần sau chỉ cần đẩy code lên là Jenkins sẽ tự kéo về jenkins container.

### Cách kết nối gitlab với jenkins qua token

1. Tạo token cho user jenkins:

Ấn vào user --> Configure --> Add new token --> Generate token.
Kết quả: `11e3a6d9965321866de7fad6abeda95483`

2. Cấu hình webhook trên GitLab

Click vào tên project (gitlab_jenkins) --> Settings --> Webhook. Ở phần url, điền như sau:

`https://tuphulam:11e3a6d9965321866de7fad6abeda95483@90fc-220-231-123-41.ngrok-free.app/project/webhook-2`

Trong đó, tuphulam là user jenkins, sau dấu `:` là token, sau dấu `@` là url dẫn đến tên project trên jenkins (nhớ chỉ copy nội dung sau phần `https://` ở url), cuối cùng thêm `/project/[tên project jenkins]` sau url. VD `/project/webhook-2`. Ta sẽ dùng user id và token thay vì password khi trao đổi thông tin giữa jenkins và gitlab bởi token bảo mật hơn. Sau đó lưu webhook và test thử, kết quả như dưới là oke.

![gitlab](../img/gitlab1.PNG)

Vậy là đã kết nối thành công gitlab project (repo webhook-2) với jenkins pipeline (project webhook-2)